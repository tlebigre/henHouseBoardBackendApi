name: Deploy HenHouse Board

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - staging

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use system Python
        run: python3 -m venv venv && source venv/bin/activate

      - name: Prepare target directory
        run: |
          mkdir -p /opt/henhouse/board

      - name: Copy sources
        run: |
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            ./ /opt/henhouse/board/

      - name: Setup virtualenv & install deps
        run: |
          cd /opt/henhouse/board
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install gRPC Python tools
        run: |
          source /opt/henhouse/board/venv/bin/activate
          python3 -m pip install grpcio grpcio-tools pydantic

      - name: Generate gRPC Python files
        run: |
          source /opt/henhouse/board/venv/bin/activate
          mkdir -p generated
          touch generated/__init__.py
          python -m grpc_tools.protoc -I./proto --python_out=generated --grpc_python_out=generated ./proto/*.proto

      - name: Restart service
        run: |
          sudo systemctl restart henhouse-board
          sudo systemctl status henhouse-board --no-pager
